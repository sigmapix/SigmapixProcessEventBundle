{% extends 'SonataAdminBundle:CRUD:base_edit.html.twig' %}

{% block form %}
<script type="text/javascript">
    $(document).ready(function(){
        // Cette fonction empêche de sélectionner plusieurs fois un même type de population
        var _c = function(){
            // on récupère les identifiants de tous les types de populations concernés
            var typesPopulationSelectionnes = $('td.sonata-ba-td-{{ admin.uniqId }}_contraintesDeModele-typePopulation select').map(function() {
                    return $( this ).val();
              });
            // on ajoute l'option 'disabled' à tous les types déjà sélectionnés dans chaque select, sauf pour les options déjà sélectionnées dans chaque select respectif 
            $('td.sonata-ba-td-{{ admin.uniqId }}_contraintesDeModele-typePopulation select > option').each(function(i, o){
                $(o).attr('disabled', ($.inArray(String($(o).val()), typesPopulationSelectionnes) !== -1) && !$(o).is(':selected'));
            })
        };

        var updatePiecesJustificatives = function($typePopulationSelect, resetData) {
            var $selectedValue = $typePopulationSelect.val();
            var $piecesJustificativesSelect = $typePopulationSelect.parent().siblings('.sonata-ba-td-{{ admin.uniqId }}_contraintesDeModele-piecesJustificatives').find('select');
            if (resetData) {
                $piecesJustificativesSelect.select2('data',null);
            }
            $piecesJustificativesSelect.find('option').each(function(i, o){
                // chaque option représentant une pièce justificative comporte un attribut 'data-pid' contenant les identifiants des types de populations concernés par cette pièce justificative
                // on ajoute l'attribut disabled à chaque option dont le 'data-pid' ne contient pas l'id du type de population concernée
                $(o).attr('disabled', ($.inArray(String($selectedValue), String($(o).data('pid')).split(',')) === -1) || $selectedValue == "");
            })
        }; 

        // Cette page
        var _d = function() {
           jQuery('td.sonata-ba-td-{{ admin.uniqId }}_contraintesDeModele-typePopulation select').on('change', function() {
                    updatePiecesJustificatives($(this), true);
                });
        }

        // On lance ces deux fonctions à l'initialisation de la page
        _c();
        _d();

        // Si on met l'événement sur le parent, il est déclenché deux fois ce qui pose problème
        jQuery('#sonata-ba-field-container-{{ admin.uniqId }}_contraintesDeModele > div').on('sonata.add_element', function(event) {
            _c();
            _d();
            jQuery('td.sonata-ba-td-{{ admin.uniqId }}_contraintesDeModele-typePopulation select').each(function() {
                updatePiecesJustificatives($(this), false);
            });
        });

    });
</script>
    {{ parent() }}
{% endblock %}